<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no" />
    <title>Spotify Vinyl Library Prototype</title>
    <style>
      :root {
        --status-bar-height: 50px;
        --bottom-nav-height: 83px;
        --interaction-zone-height: 440px;
        --album-item-height: 96px;
        --thumbnail-size: 72px;
        --bg-dark: #121212;
        --bg-status: #4a4a4a;
        --text-primary: #ffffff;
        --text-secondary: rgba(255,255,255,0.7);
        --highlight-bg: #2D2D2D;
        --border-color: rgba(255,255,255,0.1);

        /* Carousel variables - scaled up */
        --cover: 320px;
        --perspective: 1400px;
        --tiltFront: -22deg;
        --tiltBack: -65deg;
        --depth: 80px;
        --rise: 48px;
        --taper: 0.65;
        --flipMs: 700;

        /* Scale factor for responsive sizing */
        --scale-factor: 1;
      }

      * { box-sizing: border-box; margin: 0; padding: 0; }
      html, body {
        height: 100%;
        overflow: hidden;
        font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
        background: #ffffff;
      }

      /* Container for scaling */
      .scale-container {
        position: fixed;
        top: 50%;
        left: 50%;
        transform-origin: center center;
        transform: translate(-50%, -50%) scale(var(--scale-factor));
        transition: transform 0.3s ease;
      }

      /* Main Frame Container - Original size maintained */
      .frame {
        width: 402px;
        height: 874px;
        display: flex;
        flex-direction: column;
        background: var(--bg-dark);
        overflow: hidden;
        border-radius: 50px;
        box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      }

      /* Mobile: Remove border radius and shadow */
      @media (max-width: 499px) {
        .frame {
          border-radius: 0;
          box-shadow: none;
        }
      }

      /* Status Bar */
      .status-bar {
        flex-shrink: 0;
        width: 100%;
        line-height: 0;
      }

      .status-bar-img {
        width: 100%;
        height: auto;
        display: block;
      }

      /* Interaction Zone (Carousel Area) - Masked Viewport */
      .interaction-zone {
        height: var(--interaction-zone-height);
        flex-shrink: 0;
        background: #121212;
        position: relative;
        overflow: hidden;
        touch-action: none;
        /* Clip everything outside this container */
        clip-path: inset(0);
        -webkit-clip-path: inset(0);
      }

      .carousel-container {
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        perspective: var(--perspective);
        perspective-origin: 50% 55%;
        /* Allow content to extend and be clipped */
        overflow: visible;
      }

      .stack {
        position: relative;
        width: var(--cover);
        height: var(--cover);
        transform-style: preserve-3d;
        /* Position stack centered with minimal offset */
        transform: translateY(15px);
      }

      .card {
        position: absolute;
        left: 50%;
        top: 50%;
        width: var(--w, var(--cover));
        aspect-ratio: 1 / 1;
        transform-style: preserve-3d;
        transform: translate(-50%, -50%);
        overflow: hidden;
        background: #eee;
        will-change: transform, opacity;
        cursor: pointer;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2), 0 2px 8px rgba(0,0,0,0.1);
      }

      .card img, .frontFade img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        display: block;
        pointer-events: none;
        user-select: none;
        -webkit-user-drag: none;
      }

      .frontFade {
        position: absolute;
        left: 50%;
        top: 50%;
        width: var(--cover);
        height: var(--cover);
        transform: translate(-50%, -50%);
        overflow: hidden;
        pointer-events: none;
        opacity: 0;
        will-change: transform, opacity, filter;
        z-index: 9999;
        transform-origin: bottom center;
        box-shadow: 0 12px 40px rgba(0,0,0,0.25);
      }

      /* Album List */
      .album-list {
        background: var(--bg-dark);
        flex: 1;
        overflow-y: auto;
        overflow-x: hidden;
        min-height: 0;
      }

      .album-item {
        display: flex;
        align-items: center;
        padding: 12px 20px;
        height: var(--album-item-height);
        gap: 16px;
        position: relative;
        transition: background-color 0.3s ease;
        border-top: 1px solid transparent;
        cursor: pointer;
      }

      .album-item:active {
        opacity: 0.7;
      }

      .album-item.active {
        background: var(--highlight-bg);
        border-top: 1px solid var(--border-color);
      }

      .album-item.active::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 1px;
        background: rgba(255,255,255,0.15);
      }

      .album-thumbnail {
        width: var(--thumbnail-size);
        height: var(--thumbnail-size);
        border-radius: 6px;
        object-fit: cover;
        flex-shrink: 0;
        background: #2a2a2a;
      }

      .album-info {
        flex: 1;
        min-width: 0;
      }

      .album-title {
        color: var(--text-primary);
        font-size: 17px;
        font-weight: 600;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        margin-bottom: 5px;
      }

      .album-artist {
        color: var(--text-secondary);
        font-size: 15px;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
      }

      .album-more {
        color: var(--text-secondary);
        font-size: 20px;
        padding: 8px;
        cursor: pointer;
        flex-shrink: 0;
        letter-spacing: 2px;
      }

      /* Bottom Navigation */
      .bottom-nav {
        flex-shrink: 0;
        width: 100%;
        line-height: 0;
        background: #000000;
      }

      .bottom-nav-img {
        width: 100%;
        height: auto;
        display: block;
      }

      /* Scrollbar hide for album list */
      .album-list::-webkit-scrollbar {
        display: none;
      }
      .album-list {
        -ms-overflow-style: none;
        scrollbar-width: none;
      }

      /* Phone Mockup Overlay */
      .mockup-overlay {
        position: fixed;
        top: 50%;
        left: 50%;
        transform-origin: center center;
        transform: translate(-50%, -50%) scale(var(--scale-factor));
        width: 450px;
        height: auto;
        z-index: 99999;
        pointer-events: none;
        transition: transform 0.3s ease;
      }

      .mockup-overlay img {
        width: 100%;
        height: auto;
        display: block;
      }

      /* Hide mockup on mobile */
      @media (max-width: 499px) {
        .mockup-overlay {
          display: none;
        }
      }
    </style>
  </head>

  <body>
    <!-- Phone Mockup Overlay -->
    <div class="mockup-overlay">
      <img src="./export/Mockup.png" alt="Phone Mockup">
    </div>

    <div class="scale-container">
      <div class="frame">
        <!-- Status Bar -->
        <div class="status-bar">
          <img src="./export/System Top.jpg" alt="Status Bar" class="status-bar-img">
        </div>

        <!-- Interaction Zone -->
        <div class="interaction-zone" id="interactionZone">
          <div class="carousel-container">
            <div class="stack" id="stack"></div>
          </div>
        </div>

        <!-- Album List -->
        <div class="album-list" id="albumList"></div>

        <!-- Bottom Navigation -->
        <div class="bottom-nav">
          <img src="./export/Nav.jpg" alt="Navigation" class="bottom-nav-img">
        </div>
      </div>
    </div>

    <script>
      // Calculate and apply scale factor
      function calculateScale() {
        const frameHeight = 874;
        const frameWidth = 402;
        const padding = 80; // Padding for spacing
        
        const availableHeight = window.innerHeight - padding;
        const availableWidth = window.innerWidth - 40; // Side padding
        
        const scaleByHeight = availableHeight / frameHeight;
        const scaleByWidth = availableWidth / frameWidth;
        
        // Use the smaller scale to ensure it fits
        let scale = Math.min(scaleByHeight, scaleByWidth, 1);
        
        // On mobile, use full width/height
        if (window.innerWidth <= 499) {
          const mobileScaleWidth = window.innerWidth / frameWidth;
          const mobileScaleHeight = window.innerHeight / frameHeight;
          scale = Math.min(mobileScaleWidth, mobileScaleHeight);
        }
        
        document.documentElement.style.setProperty('--scale-factor', scale);
      }

      // Apply scale on load and resize
      calculateScale();
      window.addEventListener('resize', calculateScale);

      // Album data from file names
      const fileNames = [
        "1. Keith Jarrett_The Koln Concert.jpg",
        "2. Raphael Saadiq_The Way I See It Songs.jpeg",
        "3. Antonio Carlos Jobim_Wave.jpg",
        "4. D'Angelo_Black Messiah.jpg",
        "5. Carla Bley_Sextet.jpg",
        "6. Ye_Donda.png",
        "7. Ryo Fukui_Scenery.jpg",
        "8. Leon Bridges_Coming Home.jpg",
        "9. The Beatles_The Beatles.jpg",
        "10. Elis Regina & Antonio Carlos Jobim_Elis & Tom.jpg",
        "11. Erykah Badu_New Amerykah, Pt.2.jpg",
        "12. Francoise Hardy_Tous Les Garcons Et Les Filles.jpg",
        "13. Frank Ocean_Blonde.jpg",
        "14. Fred again & Brian Eno_Secret Life.webp",
        "15. Jay Z_The Blueprint.png",
        "16. Los Indios Tabajaras_Always in My Heart.jpg",
        "17. Mateo Stoneman_Mateo.jpg",
        "18. Radiohead_A Moon Shaped Pool.png",
        "19. Sergio Mendes_Timeless.jpg",
        "20. Stan Getz_The Best of Two Worlds.jpg"
      ];

      const albums = fileNames.map(name => {
        const lastDotIndex = name.lastIndexOf('.');
        const nameWithoutExt = name.substring(0, lastDotIndex);
        const [numPart, dataPart] = nameWithoutExt.split('. ');
        const [artist, title] = dataPart ? dataPart.split('_') : ["Unknown Artist", numPart];
        return {
          id: `album-${numPart}`,
          artist: artist ? artist.trim() : "Unknown Artist",
          title: title ? title.trim() : "Unknown Title",
          coverUrl: `./assets/${name}`
        };
      });

      // DOM Elements
      const stack = document.getElementById("stack");
      const interactionZone = document.getElementById("interactionZone");
      const albumListEl = document.getElementById("albumList");

      // Utility functions
      const cssNum = (name) => parseFloat(getComputedStyle(document.documentElement).getPropertyValue(name));
      const lerp = (a, b, t) => a + (b - a) * t;
      const clamp = (v, a, b) => Math.max(a, Math.min(b, v));
      const mod = (n, m) => ((n % m) + m) % m;

      // Carousel constants
      const COVER = cssNum("--cover");
      const TILT_FRONT = cssNum("--tiltFront");
      const TILT_BACK = cssNum("--tiltBack");
      const DEPTH = cssNum("--depth");
      const RISE = cssNum("--rise");
      const TAPER = cssNum("--taper");
      const FLIP_MS = cssNum("--flipMs");

      const VISIBLE = Math.min(albums.length, 8);
      const DRAG_THRESHOLD_PX = 40;
      const WHEEL_THRESHOLD_PX = 100;
      const WHEEL_CLAMP = 60;
      const MOVE_START_RATIO = 0.14;
      const ROT_END = 105;
      const POPZ_END = 340;
      const DROPY_END = 240;
      const FADE_START_T = 0.55;
      const BLUR_MAX = 12;
      const INSTANT_BLUR = 2.4;
      const SMOOTH_BLUR_EXTRA = 3.2;
      const SMOOTH_WINDOW_T = 0.26;
      const INSTANT_FADE = 0.04;

      let head = 0;
      let animating = false;
      let progress = 0;
      let lastTs = 0;
      let wheelAccum = 0;

      // Easing functions
      function easeOutQuart(t) { return 1 - Math.pow(1 - t, 4); }
      function easeInOutCubic(t) { return t < 0.5 ? 4 * t * t * t : 1 - Math.pow(-2 * t + 2, 3) / 2; }
      function easeOutCubic(t) { return 1 - Math.pow(1 - t, 3); }

      function albumIndexForSlot(slot) { return mod(head + slot, albums.length); }

      // Build Album List
      function buildAlbumList() {
        albumListEl.innerHTML = '';
        albums.forEach((album, index) => {
          const item = document.createElement('div');
          item.className = 'album-item' + (index === 0 ? ' active' : '');
          item.dataset.index = index;
          item.innerHTML = `
            <img class="album-thumbnail" src="${album.coverUrl}" alt="${album.title}">
            <div class="album-info">
              <div class="album-title">${album.title}</div>
              <div class="album-artist">${album.artist}</div>
            </div>
            <div class="album-more">•••</div>
          `;
          albumListEl.appendChild(item);
        });
      }

      // Update active album in list
      function updateActiveAlbum(index) {
        const items = albumListEl.querySelectorAll('.album-item');
        items.forEach((item, i) => {
          item.classList.toggle('active', i === index);
        });

        // Scroll the active item to the top of the list
        const activeItem = items[index];
        if (activeItem) {
          albumListEl.scrollTo({
            top: activeItem.offsetTop - albumListEl.offsetTop,
            behavior: 'smooth'
          });
        }
      }

      // Smooth jump animation
      const JUMP_DURATION = 350;
      let jumping = false;

      function jumpToAlbum(index) {
        if (animating || jumping || index === head) return;
        jumping = true;

        // Update data immediately
        head = index;
        refreshImages();
        updateActiveAlbum(head);

        // Animate the front card with a smooth fade in
        cards[0].style.opacity = "0";
        cards[0].style.transform = `translate(-50%, -50%) translate3d(0px, 0px, 0px) rotateX(${TILT_FRONT}deg) scale(0.95)`;

        const startTime = performance.now();

        function animateJump(ts) {
          const elapsed = ts - startTime;
          const t = clamp(elapsed / JUMP_DURATION, 0, 1);

          // Ease out cubic
          const easeT = 1 - Math.pow(1 - t, 3);

          // Fade in and scale up
          cards[0].style.opacity = String(easeT);
          const scale = 0.95 + (0.05 * easeT);
          cards[0].style.transform = `translate(-50%, -50%) translate3d(0px, 0px, 0px) rotateX(${TILT_FRONT}deg) scale(${scale})`;

          if (t < 1) {
            requestAnimationFrame(animateJump);
          } else {
            jumping = false;
            layoutWithShift(0);
          }
        }

        requestAnimationFrame(animateJump);
      }

      // Album list click handler
      albumListEl.addEventListener('click', (e) => {
        const item = e.target.closest('.album-item');
        if (!item) return;
        const index = parseInt(item.dataset.index, 10);
        if (Number.isFinite(index)) {
          jumpToAlbum(index);
        }
      });

      // Create carousel cards
      const cards = Array.from({ length: VISIBLE }).map((_, slot) => {
        const el = document.createElement("div");
        el.className = "card";
        el.dataset.slot = String(slot);
        const img = document.createElement("img");
        img.draggable = false;
        el.appendChild(img);
        stack.appendChild(el);
        return el;
      });

      // Create front fade overlay
      const frontFade = document.createElement("div");
      frontFade.className = "frontFade";
      const frontFadeImg = document.createElement("img");
      frontFadeImg.draggable = false;
      frontFade.appendChild(frontFadeImg);
      stack.appendChild(frontFade);

      function refreshImages() {
        for (let slot = 0; slot < VISIBLE; slot++) {
          const idx = albumIndexForSlot(slot);
          const img = cards[slot].querySelector("img");
          img.src = albums[idx].coverUrl;
          img.alt = `${albums[idx].title} — ${albums[idx].artist}`;
        }
        frontFadeImg.src = albums[head].coverUrl;
        frontFadeImg.alt = `${albums[head].title} — ${albums[head].artist}`;
      }

      function layoutWithShift(shift) {
        for (let slot = 0; slot < VISIBLE; slot++) {
          const el = cards[slot];
          const slotPos = slot - shift;
          const abs = Math.abs(slotPos);
          const y = -slotPos * RISE;
          const z = -abs * DEPTH;
          const tiltT = clamp(abs / 5, 0, 1);
          const rotX = lerp(TILT_FRONT, TILT_BACK, tiltT);
          const w = COVER * lerp(1.0, TAPER, clamp(abs / 6, 0, 1));
          const scale = lerp(1.0, 0.80, clamp(abs / 6, 0, 1));

          if (animating && slot === 0) el.style.opacity = "0";
          else el.style.opacity = "1";

          el.style.setProperty("--w", `${w}px`);
          el.style.transform = `translate(-50%, -50%) translate3d(0px, ${y}px, ${z}px) rotateX(${rotX}deg) scale(${scale})`;
          el.style.zIndex = String(1000 - Math.round(abs * 120));
        }
      }

      function resetTopple() {
        frontFade.style.opacity = "0";
        frontFade.style.filter = "blur(0px)";
        frontFade.style.transform = `translate(-50%, -50%) rotateX(${TILT_FRONT}deg)`;
      }

      function commitStep() {
        head = mod(head + 1, albums.length);
        refreshImages();
        updateActiveAlbum(head);
        resetTopple();
      }

      function beginStep() {
        if (animating || jumping) return;
        animating = true;
        progress = 0;
        lastTs = 0;

        frontFadeImg.src = albums[head].coverUrl;
        frontFade.style.opacity = String(1 - INSTANT_FADE);
        frontFade.style.filter = `blur(${INSTANT_BLUR.toFixed(2)}px)`;
        frontFade.style.transform = `translate(-50%, -50%) rotateX(${TILT_FRONT}deg)`;
        cards[0].style.opacity = "0";

        requestAnimationFrame(tick);
      }

      function tick(ts) {
        if (!animating) return;
        if (!lastTs) lastTs = ts;

        const dt = ts - lastTs;
        lastTs = ts;
        progress += dt / FLIP_MS;

        const t = clamp(progress, 0, 1);
        const fallT = easeOutQuart(t);
        // Flip towards user (positive rotation instead of negative)
        const rotate = lerp(TILT_FRONT, -ROT_END, fallT);
        const popZ = lerp(0, POPZ_END, fallT);
        const dropY = lerp(0, DROPY_END, fallT * fallT);

        const smoothAmt = clamp(t / SMOOTH_WINDOW_T, 0, 1);
        const smoothExtra = SMOOTH_BLUR_EXTRA * easeOutQuart(smoothAmt);
        const fadeAmt = clamp((t - FADE_START_T) / (1 - FADE_START_T), 0, 1);
        const mainFade = easeInOutCubic(fadeAmt);
        const mainBlur = BLUR_MAX * Math.pow(fadeAmt, 0.9);

        const opacity = clamp((1 - INSTANT_FADE) - mainFade, 0, 1);
        const blur = INSTANT_BLUR + smoothExtra + mainBlur;

        frontFade.style.opacity = String(opacity);
        frontFade.style.filter = `blur(${blur.toFixed(2)}px)`;
        frontFade.style.transform = `translate(-50%, -50%) translate3d(0px, ${dropY.toFixed(2)}px, ${popZ.toFixed(2)}px) rotateX(${rotate.toFixed(2)}deg)`;

        let shiftT = 0;
        if (t > MOVE_START_RATIO) {
          const moveProgress = (t - MOVE_START_RATIO) / (1 - MOVE_START_RATIO);
          shiftT = easeOutCubic(clamp(moveProgress, 0, 1));
        }
        layoutWithShift(shiftT);

        if (progress >= 1) {
          animating = false;
          lastTs = 0;
          wheelAccum = 0;
          commitStep();
          layoutWithShift(0);
          return;
        }
        requestAnimationFrame(tick);
      }

      // Click on back cards to advance
      stack.addEventListener("click", (e) => {
        if (animating) return;
        const card = e.target.closest?.(".card");
        if (!card) return;
        const slot = parseInt(card.dataset.slot, 10);
        if (Number.isFinite(slot) && slot > 0) beginStep();
      });

      // Drag interaction
      let isDown = false;
      let startY = 0;
      let dragTriggered = false;

      interactionZone.addEventListener("pointerdown", (e) => {
        if (animating) return;
        isDown = true;
        dragTriggered = false;
        startY = e.clientY;
        e.target.setPointerCapture?.(e.pointerId);
      });

      interactionZone.addEventListener("pointermove", (e) => {
        if (!isDown || animating || dragTriggered) return;
        const dy = e.clientY - startY;
        if (dy <= 0) return;
        if (dy >= DRAG_THRESHOLD_PX) {
          dragTriggered = true;
          beginStep();
        }
      });

      const endDrag = () => { isDown = false; dragTriggered = false; };
      interactionZone.addEventListener("pointerup", endDrag);
      interactionZone.addEventListener("pointercancel", endDrag);

      // Wheel interaction
      interactionZone.addEventListener("wheel", (e) => {
        e.preventDefault();
        if (animating || e.deltaY <= 0) return;
        const dy = clamp(e.deltaY, 0, WHEEL_CLAMP);
        wheelAccum += dy;
        if (wheelAccum >= WHEEL_THRESHOLD_PX) {
          wheelAccum = 0;
          beginStep();
        }
      }, { passive: false });

      // Keyboard interaction
      window.addEventListener("keydown", (e) => {
        if (!animating && (e.key === "ArrowDown" || e.key === "PageDown" || e.key === " ")) {
          e.preventDefault();
          beginStep();
        }
      });

      // Initialize
      buildAlbumList();
      refreshImages();
      updateActiveAlbum(head);
      layoutWithShift(0);
      resetTopple();
    </script>
  </body>
</html>
